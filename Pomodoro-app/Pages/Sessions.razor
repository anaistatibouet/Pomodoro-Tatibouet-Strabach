@page "/Sessions"
@using Model;
@using System.Text.Json;
@inject IModalService Modal

<SessionsForm></SessionsForm>
<div>
    <img src="../medias/images/kitten.png" alt="kitten" class="kitten-left" />
</div>
<div>
    <span id="resultJson"></span>
</div>

<div class="m-5">
    <table class="table m-auto" style="width:60vw">
        <thead class="thead-dark">
            <tr>
                <th scope="col">Id</th>
                <th scope="col">Nom</th>
                <th scope="col">Nombre de pomodoros</th>
                <th scope="col">Démarrer</th>
            </tr>
        </thead>
        <tbody>
            @if (SessionsList.Count == 0)
            {
                <tr>

                    <td>
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-dark" role="status"></div>
                            <p class="ml-3 mt-2">@LoadingMessage</p>
                        </div>
                    </td>
                </tr>
            }
            else
            {
                @foreach (SessionModel item in SessionsList)
                {
                    <tr>
                        <td>
                            @item.Id
                        </td>
                        <td>
                            @item.Name
                        </td>
                        <td>
                            @item.NbPomodoros
                        </td>
                        <td>
                            <button class="btn btn-primary mr-3"><span class="oi oi-pencil" @onclick="@(() => EditSession(@item.Id))"></span></button>
                            <button class="btn btn-danger" @onclick="@(() => DeleteSession(@item.Id))"><span class="oi oi-trash text-white"></span></button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {

    [CascadingParameter] ModalParameters Parameters { get; set; }

    private SessionModel _sessionModel = new SessionModel();
    private List<SessionModel> SessionsList = new List<SessionModel>();
    HttpClient Http = new HttpClient();

    bool ShowModal { get; set; } = true;

    private string LoadingMessage = "Liste des sessions en cours de chargement...";
    private string StatusMessage { get; set; }
    private string Placeholder = "Nom de la session";

    private bool Insert = true;
    private bool ConfirmDelete { get; set; }

    // Requête GET pour afficher les sessions
    #region Display
    protected override async Task OnInitializedAsync()
    {
        SessionsList = await Http.GetJsonAsync<List<SessionModel>>("https://localhost:44313/api/Sessions");
    }
    #endregion

    // Requête DELETE pour supprimer une session
    #region Removal
    protected async Task DeleteSession(int SessionId)
    {
        await Http.DeleteAsync($"https://localhost:44313/api/Sessions/{SessionId}");
        SessionsList = await Http.GetJsonAsync<List<SessionModel>>("https://localhost:44313/api/Sessions");
    }
    #endregion

    // Requête PUT pour modifier une session
    #region Edition
    private void EditSession(int id)
    {
        this.Insert = false;
        var editSession = SessionsList.Single(i => i.Id == id);
        _sessionModel = new SessionModel { Id = editSession.Id, Name = editSession.Name };
    }

    private async Task SaveSession()
    {
        await Http.PutJsonAsync($"https://localhost:44313/api/Sessions/{_sessionModel.Id}", _sessionModel);
        SessionsList = await Http.GetJsonAsync<List<SessionModel>>("https://localhost:44313/api/Sessions");
        this.Insert = true;
    }
    #endregion

    void ShowModalTag()
    {
        var parameters = new ModalParameters();
        //parameters.Add("FormId", 11);

        Modal.OnClose += ModalClosed;
        Modal.Show<TagsModal>("Tags pomodoros", parameters);

    }

    void ModalClosed(ModalResult modalResult)
    {
        Console.WriteLine("Modal has closed");

        if (modalResult.Cancelled)
        {
            Console.WriteLine("Modal was Cancelled");
        }
        else
        {
            Console.WriteLine(modalResult.Data.ToString());
        }

        Modal.OnClose -= ModalClosed;
    }

}